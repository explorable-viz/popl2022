\subsection{Selections of a value}

\todo{It would be useful to say why we define $\Sel{\raw{v}}{A}$ here. I understand what it is, but I do not (yet) know why we are introducing this.}

The raw (unselectable) syntax described in \secref{core-language} can be recovered from selectable terms via the erasure operation $\erase{v}: \ValF{\Ann{A}} \to \ValF{\Unit}$ which forgets the selection information, where $\Unit$ is the trivial one-point lattice. We refer to $|v|$ as the \emph{shape} of $v$, which is useful because we will be mostly concerned with the selectable values of a given shape. Allowing $\raw{u}, \raw{v}$ from now on to range over raw values, and reserving $u, v$ for selectable values (and similarly for the other syntactic forms), we have:

\begin{definition}[Selections of $\raw{v}$]
   Define $\Sel{\raw{v}}{A}$ to be the set of all values $v \in \ValF{\textcal{A}}$ with shape $\raw{v}$, i.e.
   ~that erase to $\raw{v}$.
\end{definition}

Since its elements have a fixed shape, $\SelF{v}$ is a ``representable'' functor: it is isomorphic to a function space whose domain is the set of selection positions in $\raw{v}$. In particular, the pointwise comparison of any $v, v'$ in $\Sel{\raw{v}}{A}$ using the partial order $\leq$ of $\Ann{A}$ is well defined, as is the pointwise application (zip) of a binary operation~\cite{gibbons17}. It should be clear that if $\Ann{A}$ is a lattice, then $\Sel{\raw{v}}{A}$ is also a lattice, with $\top_{\raw{v}}$, $\bot_{\raw{v}}$, $\meet_{\raw{v}}$, and $\join_{\raw{v}}$ defined pointwise. For example, if $u$ and $u'$ have the same shape and $v$ and $v'$ have the same shape, the join of the lists $(\annCons{u}{v}{\alpha})$ and $(\annCons{u'}{v'}{\alpha'})$ is defined and equal to $\annCons{(u \join u')}{(v \join v')}{\alpha \join \alpha'}$. Similarly, the top element of $\Sel{\raw{v}}{A}$ is the selection of $\raw{v}$ which has $\top$ at every selection position. (We omit the $\raw{v}$ indices from the lattice operations if it is clear which lattice is being referred to.)

\todo{Would it make sense to give an example of different lattices that are useful? I guess the one we use in the examples is really just 0/1. Do we have an example of something more sophisticated that is useful and somehow more powerful?}

\subsubsection{Environment selections and hole equivalence}

The notion of a ``selection'' of $\raw{v}$ also extends pointwise to environments, so that $\Sel{\raw{\rho}}{A}$ means the set of selectable environments $\rho'$ of shape $\raw{\rho}$, where the variables in $\rho'$ are bound to selections of the corresponding variables in $\rho$. One challenge arises from the pointwise use of $\join$ to combine environment selections. Since environments contain other environments recursively through closures, environment join is a very expensive operation if treated naively. One implementation option is to employ an efficient representation of values which are fully unselected, which is the case for the majority of bindings in an environment.

We therefore enrich the set of selectable values $\ValF{\Ann{A}}$ with a distinguished element \emph{hole}, written $\hole$, which is an alternative notation for $\bot_{\raw{v}}$ for any $\raw{v}$, i.e.~the selectable value of shape $\raw{v}$ which has $\bot$ at every selection position. The equivalence of $\hole$ to any such bottom element is established explicitly by the partial order defined in \figref{data-dependencies:leq}: the first rule always allows $\hole$ on the left-hand side of $\leq$, and other rules allow $\hole$ on the right-hand side of $\leq$ as long as all the selections that appear on the left-hand side are $\bot$. (The rules for recursive definitions $h$, eliminators $\sigma$ and terms $e$ are analogous and are omitted.) If we write $\eq$ for the equivalence relation induced by $\leq$ on selectable values, which we call \emph{hole-equivalence}, it should be clear that $\hole \join v \eq v$ and $\hole \meet v \eq \hole$. This means the join of two selections $v, v'$ of $\raw{v}$ can be implemented efficiently, whenever one selection is $\hole$, by simply discarding $\hole$ and returning the other selection without further processing.

\begin{definition}[Hole equivalence]
   Define $\eq$ as the intersection of $\leq$ and $\geq$.
\end{definition}

Because $\hole$ is equivalent to $\bot_{\raw{v}}$ for any $\raw{v}$, all such bottom elements are hole-equivalent. For example, the selectable value $\annCons{\hole}{\hole}{\top}$ is hole-equivalent to $\annCons{5_{\bot}}{\hole}{\top}$, but also to $\annCons{6_{\bot}}{{\exNil_{\bot}}}{\top}$, and so the last two terms are hole-equivalent by transitivity. However, we only use the hole ordering to compare elements of a given $\Sel{\raw{v}}{A}$.
