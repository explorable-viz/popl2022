\begin{figure}
\flushleft \shadebox{$\rho, \indexed{e} \eval{\sigma} \explVal{\indexed{U}}{\indexed{u}}, \rho', \kappa$}
\begin{smathpar}
\inferrule*
{
   \strut
}
{
   \rho,
   \indexed{e}
   \eval{\trieVar{x}{\kappa}}
   \explVal{\indexed{e}}{\exBot},
   \envExtend{\envEmpty}{x}{\recEnvEntry{\rho}{\envEmpty}{\indexed{e}}},
   \kappa
}
%
\and
%
\inferrule*[right={$
   \exThunkVar{x}{\recEnvEntry{\rho'}{\delta}{\indexed{e}}} \in \rho \wedge
   \envType{\Gamma}{\rho' \concat \closeDefs{\delta}{\rho'}}
$}]
{
   \rho' \concat \closeDefs{\delta}{\rho'},
   \shift{\closeDefs{\delta}{\rho'}}{\indexed{e}}
   \eval{\tau}
   \explVal{\indexed{T}}{\indexed{v}},
   \rho^\twoPrime,
   \kappa
}
{
   \rho,
   \raw{\exVar{x}}{\idx{i}}
   \eval{\tau}
   \explVal{\raw{(\trVar{x}{\Gamma}{\indexed{T}})}{\idx{i}}}{\indexed{v}},
   \rho^\twoPrime,
   \kappa
}
%
\and
%
\inferrule*[right={$\interpret{\exConst{c}} \in \tyGround{C}$}]
{
   \strut
}
{
   \rho,
   \raw{\exConst{c}}{\idx{i}}
   \eval{\trieGround{C}{\kappa}}
   \explVal
      {\raw{\trEmpty}{\idx{i}}}
      {\raw{\exConst{c}}{\idx{i}}},
   \envEmpty,
   \kappa
}
%
\and
%
\inferrule*
{
   \strut
}
{
   \rho,
   \raw{\phi}{\idx{i}}
   \eval{\trieFun{\kappa}}
   \explVal
      {\raw{\trEmpty}{\idx{i}}}
      {\raw{\phi}{\idx{i}}},
   \envEmpty,
   \kappa
}
%
\and
%
\inferrule*
{
   \strut
}
{
   \rho,
   \raw{\exFun{\sigma}}{\idx{i}}
   \eval{\trieFun{\kappa}}
   \explVal
      {\raw{\trEmpty}{\idx{i}}}
      {\raw{\exClosure{\rho}{\exFun{\sigma}}}{\idx{i}}},
   \envEmpty,
   \kappa
}
%
\and
%
   \inferrule*[right={$\envType{\Gamma}{\rho_1 \concat \rho_2}$}]
   {
      \rho, \indexed{e} \eval{\trieFun{\metaunit}}
      \explVal{\indexed{T}}{\raw{\exClosure{\rho_1}{\exFun{\sigma}}}{\idx{j}}}, \envEmpty, \metaunit
      \\
      \rho, \indexed{e}' \eval{\sigma} \explVal{\indexed{T}'}{\indexed{u}}, \rho_2, \indexed{e}^\twoPrime
      \\
      \rho_1 \concat \rho_2,
      \shift{\rho_2}{\indexed{e}^\twoPrime}
      \eval{\tau}
      \explVal{\indexed{T}^\twoPrime}{\indexed{v}}, \rho', \kappa
   }
   {
      \rho,
      \raw{(\exApp{\indexed{e}}{\indexed{e}'})}{\idx{i}}
      \eval{\tau}
      \explVal
         {\raw
            {\smash{(\trApp{(\explVal{\indexed{T}}{\raw{\exClosure{\rho_1}{\exFun{\sigma}}}{\idx{j}}})}
                           {(\explVal{\indexed{T'}}{\indexed{u}})}
                           {\indexed{T^\twoPrime}})}}
            {\idx{i}}}
         {\indexed{v}},
      \rho',
      \kappa
   }
%
\and
%
\inferrule*[right={\textnormal{
   $\interpret{\phi} \in \UnaryOp{C}{A} \wedge \interpret{\phi}(c, \tau) = (v, \kappa)$
}}]
{
   \rho, \indexed{e} \eval{\trieFun{\metaunit}} \explVal{\indexed{T}}{\raw{\phi}{\idx{j}}}, \envEmpty, \metaunit
   \\
   \rho, \indexed{e}' \eval{\trieGround{C}{\metaunit}} \explVal{\indexed{T}'}{\raw{c}{\idx{k}}}, \envEmpty, \metaunit
}
{
   \rho,
   \raw{(\exApp{\indexed{e}}{\indexed{e}'})}{\idx{i}}
   \eval{\tau}
   \explVal
      {\raw{\smash{(\trApp{(\explVal{\indexed{T}}{\raw{\phi}{\idx{j}}})}
                          {(\explVal{\indexed{T}'}{\raw{c}{\idx{k}}})}
                          {\trBot})}}
           {\idx{i}}}
      {\raw{v}{\idx{i}}},
   \envEmpty,
   \kappa
}
%
\and
%
\inferrule*[right={\textnormal{
   $\interpret{\primOp} \in \BinaryOp{C}{C'}{A} \wedge \interpret{\primOp}(c, c', \tau) = (v, \kappa)$
}}]
{
   \rho, e \eval{\trieGround{C}{\metaunit}} \explVal{\indexed{T}}{\raw{c}{\idx{j}}}, \envEmpty, \metaunit
   \\
   \rho, e' \eval{\trieGround{C'}{\metaunit}} \explVal{\indexed{T}'}{\raw{\smash{c'}}{\idx{k}}}, \envEmpty, \metaunit
}
{
   \rho,
   \raw{(\exPrimApp{\indexed{e}}{\primOp}{\indexed{e}'})}{\idx{i}}
   \eval{\tau}
   \explVal
      {\raw{\smash{\trPrimApp{(\explVal{\indexed{T}}{\raw{c}{\idx{j}}})}
                             {\primOp}
                             {(\explVal{\indexed{T}'}{\raw{\smash{c'}}{\idx{k}}})}}}{\idx{i}}}
      {\raw{v}{\idx{i}}},
   \envEmpty,
   \kappa
}
%
\and
%
\inferrule*
{
   \rho,
   \vec{\indexed{e}}
   \eval{\Sigma(d)}
   \vec{\explVal{\indexed{T}}{\indexed{u}}},
   \rho',
   \kappa
}
{
   \rho,
   \raw{\exConstr{d}{\vec{\indexed{e}}}}{\idx{i}}
   \eval{\Sigma}
   \explVal
      {\raw{\trEmpty}{\idx{i}}}
      {\raw{\exConstr{d}{\vec{\explVal{\indexed{T}}{\indexed{u}}}}}{\idx{i}}},
   \rho',
   \kappa
}
%
\and
%
\inferrule*
{
   \rho, \indexed{e} \eval{\sigma} \explVal{\indexed{U}}{\indexed{u}}, \rho', \indexed{e}'
   \\
   \rho \concat \rho',
   \shift{\rho'}{\indexed{e}'}
   \eval{\tau}
   \explVal{\indexed{T}}{\indexed{v}},
   \rho^\twoPrime,
   \kappa
}
{
   \rho,
   \raw{(\exMatch{\indexed{e}}{\sigma})}{\idx{i}}
   \eval{\tau}
   \explVal
      {\raw{(\trMatch{\explVal{\indexed{U}}{u}}{\sigma}{\Gamma}{\indexed{T}})}{\idx{i}}}
      {\indexed{v}},
   \rho^\twoPrime,
   \kappa
}
%
\and
%
\inferrule*
{
   \rho \concat \closeDefs{\delta}{\rho},
   \shift{\closeDefs{\delta}{\rho}}{\indexed{e}}
   \eval{\tau}
   \explVal{\indexed{T}}{\indexed{v}},
   \rho',
   \kappa
}
{
   \rho,
   \raw{(\exLetrec{\delta}{\indexed{e}})}{\idx{i}}
   \eval{\tau}
   \explVal
      {\raw{(\trLetrec{\delta}{\indexed{T}})}{\idx{i}}}
      {\indexed{v}},
   \rho',
   \kappa
}
\end{smathpar}
\caption{Evaluation for persistent terms}
\end{figure}
